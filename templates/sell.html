{% extends "base.html" %}

{% block title %}Sell Your Book - SWAPLY{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-8">
    <h1 class="text-4xl font-bold text-gray-800 mb-2">Sell Your Book</h1>
    <p class="text-gray-600 mb-8">List your textbook and help fellow students save money!</p>

    <div class="bg-white rounded-lg shadow-md p-8">
        <form id="sellForm" class="space-y-6">
            <!-- Book Information -->
            <div class="max-w-4xl mx-auto px-4 py-8">
                <div id="authCheck" class="hidden">
                    <!-- This will show if user is not logged in -->
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl mb-6">
                        <div class="flex items-center">
                            <div class="py-1">⚠️</div>
                            <div class="ml-3">
                                <p class="font-semibold">Authentication Required</p>
                                <p class="text-sm">Please <a href="/login" class="underline font-semibold">login with
                                        your Google account</a> to list books.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <h1 class="text-4xl font-bold text-gray-800 mb-2">Sell Your Book</h1>
                <p class="text-gray-600 mb-8">List your textbook and help fellow students save money!</p>

                <div class="bg-white rounded-lg shadow-md p-8">
                    <form id="sellForm" class="space-y-6">
                        <!-- Rest of your form remains the same -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="title" class="block text-sm font-medium text-gray-700 mb-2">Book Title
                                    *</label>
                                <input type="text" id="title" name="title" required
                                    class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>

                            <div>
                                <label for="author" class="block text-sm font-medium text-gray-700 mb-2">Author
                                    *</label>
                                <input type="text" id="author" name="author" required
                                    class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="isbn" class="block text-sm font-medium text-gray-700 mb-2">ISBN</label>
                                <input type="text" id="isbn" name="isbn"
                                    class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>

                            <div>
                                <label for="price" class="block text-sm font-medium text-gray-700 mb-2">Price ($)
                                    *</label>
                                <input type="number" id="price" name="price" step="0.01" min="0" required
                                    class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>

                        <div>
                            <label for="condition" class="block text-sm font-medium text-gray-700 mb-2">Condition
                                *</label>
                            <select id="condition" name="condition" required
                                class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select Condition</option>
                                <option value="New">New - Never used</option>
                                <option value="Like New">Like New - Minimal signs of use</option>
                                <option value="Good">Good - Some highlighting/notes</option>
                                <option value="Fair">Fair - Significant wear but usable</option>
                            </select>
                        </div>

                        <div>
                            <label for="description"
                                class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                            <textarea id="description" name="description" rows="4"
                                class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="Describe the book's condition, any markings, edition, etc."></textarea>
                        </div>

                        <!-- Seller Information -->
                        <div class="border-t pt-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Your Information</h3>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="seller_name" class="block text-sm font-medium text-gray-700 mb-2">Your
                                        Name *</label>
                                    <input type="text" id="seller_name" name="seller_name" required
                                        class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>

                                <div>
                                    <label for="seller_email" class="block text-sm font-medium text-gray-700 mb-2">Email
                                        *</label>
                                    <input type="email" id="seller_email" name="seller_email" required
                                        class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>

                            <div class="mt-4">
                                <label for="seller_phone" class="block text-sm font-medium text-gray-700 mb-2">Phone
                                    Number</label>
                                <input type="tel" id="seller_phone" name="seller_phone"
                                    class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="flex justify-center pt-4">
                            <button type="submit"
                                class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition duration-300 font-semibold text-lg">
                                List My Book
                            </button>
                        </div>
                    </form>

                    <div id="message" class="mt-4 text-center hidden"></div>
                </div>

                <!-- Guidelines -->
                <div class="bg-blue-50 rounded-lg p-6 mt-8">
                    <h3 class="text-lg font-semibold text-blue-800 mb-4">Selling Guidelines</h3>
                    <ul class="text-blue-700 space-y-2">
                        <li>• Provide accurate information about the book's condition</li>
                        <li>• Set a fair price based on the book's condition and edition</li>
                        <li>• Respond promptly to interested buyers</li>
                        <li>• Meet in safe, public locations on campus for exchanges</li>
                        <li>• Only list books you legally own and have the right to sell</li>
                    </ul>
                </div>
            </div>
            {% endblock %}

            {% block scripts %}
            <script>
                // Check if user is logged in
                fetch('/api/user')
                    .then(response => response.json())
                    .then(data => {
                        if (!data.logged_in) {
                            document.getElementById('authCheck').classList.remove('hidden');
                            document.getElementById('sellForm').style.display = 'none';
                            document.querySelector('h1').textContent = 'Login Required';
                            document.querySelector('p').textContent = 'Please login with your Google account to sell books.';
                        } else {
                            // Pre-fill seller information
                            document.getElementById('seller_name').value = data.user.name;
                            document.getElementById('seller_email').value = data.user.email;

                            // Make these fields read-only since we have the info
                            document.getElementById('seller_name').readOnly = true;
                            document.getElementById('seller_email').readOnly = true;
                        }
                    });

                // Rest of your existing sell form JavaScript
                document.getElementById('sellForm').addEventListener('submit', function (e) {
                    e.preventDefault();

                    const formData = new FormData(this);
                    const bookData = {
                        title: formData.get('title'),
                        author: formData.get('author'),
                        isbn: formData.get('isbn'),
                        price: formData.get('price'),
                        condition: formData.get('condition'),
                        description: formData.get('description'),
                        seller_name: formData.get('seller_name'),
                        seller_email: formData.get('seller_email'),
                        seller_phone: formData.get('seller_phone'),
                        timestamp: new Date().toISOString()
                    };

                    fetch('/api/add-book', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(bookData)
                    })
                        .then(response => response.json())
                        .then(data => {
                            const messageDiv = document.getElementById('message');
                            messageDiv.className = 'mt-4 text-center p-4 rounded-lg';

                            if (data.success) {
                                messageDiv.className += ' bg-green-100 text-green-700';
                                messageDiv.textContent = data.message;
                                document.getElementById('sellForm').reset();
                            } else {
                                messageDiv.className += ' bg-red-100 text-red-700';
                                messageDiv.textContent = data.error || 'Error listing book. Please try again.';
                            }

                            messageDiv.classList.remove('hidden');

                            // Scroll to message
                            messageDiv.scrollIntoView({ behavior: 'smooth' });
                        })
                        .catch(error => {
                            const messageDiv = document.getElementById('message');
                            messageDiv.className = 'mt-4 text-center p-4 rounded-lg bg-red-100 text-red-700';
                            messageDiv.textContent = 'Error listing book. Please try again.';
                            messageDiv.classList.remove('hidden');
                        });
                });
            </script>
            {% endblock %}